build:
  nodes:
    analysis:
      dependencies:
        before:
          - composer require twig/twig mindplay/annotations phpfastcache/phpfastcache monolog/monolog czproject/git-php phpmv/php-mv-ui
          - composer require codeception/codeception --dev
      environment:
        php:
          version: 7.2
      tests:
        override:
          - php-scrutinizer-run

    coverage:
      dependencies:
        before:
          - sudo apt-get install -y zip

      environment:
        php:
          version: 7.2
        hosts:
          dev.local: '127.0.0.1'
        apache2:
          modules: ['rewrite']
          sites:
            ubiquity:
              host: 'dev.local'
              web_root: 'tests/fw/'
        selenium: true
      services:
          # For available tags, see https://hub.docker.com/_/mysql/
          mysql: 5.7
      tests:
        before:
          - sudo cp tests/fw/xdebug.ini /home/scrutinizer/.phpenv/versions/7.2.13/etc/conf.d/xdebug.ini
          - mysql -u root mysql < tests/unit/db/messagerie.sql
          - (cd tests/fw && yes | ./../../vendor/bin/Ubiquity new prj-test-admin -b=messagerie -q=semantic -m -a)
          - cp tests/fw/composer.json tests/fw/prj-test-admin/
          - composer --working-dir=$(pwd)/tests/fw/prj-test-admin update
          - cp tests/fw/_index.php tests/fw/prj-test-admin/index.php && cp tests/fw/xdebug.php tests/fw/prj-test-admin/xdebug.php
          - cp -R Ubiquity tests/fw/prj-test-admin/Ubiquity/
          - cp tests/fw/codeception.yml tests/fw/prj-test-admin/codeception.yml
          - unzip tests/fw/tests.zip -d tests/fw/prj-test-admin/tests/

          - cp tests/fw/c3.php tests/fw/prj-test-admin/c3.php
          - sudo chmod 777 -R tests/ && sudo chown -R www-data:www-data tests/fw/
          - sudo service apache2 restart && sudo service apache2 reload && sudo curl -v http://dev.local/prj-test-admin/xdebug.php
          - mv composer-tests.json composer.json
          - composer update

        override:
          - command: ./vendor/bin/codecept build && ./vendor/bin/codecept run --coverage && cp tests/fw/prj-test-admin/tests/_output/c3tmp/codecoverage.serialized tests/_output/remote.codecoverage.serialized && ./vendor/bin/phpcov merge tests/_output/ --clover tests/_output/clover.xml
            coverage:
              file: tests/_output/clover.xml
              format: clover
filter:
    excluded_paths:
        - Ubiquity/log/
        - Ubiquity/controllers/Autoloader.php
        - Ubiquity/controllers/admin/
        - Ubiquity/annotations/
        - Ubiquity/js/Jquery.php
        - Ubiquity/utils/git/UGitRepository.php
        - docs/
        - api/
        - documentation/
        - tests/
checks:
    php:
        code_rating: true
        duplication: true
