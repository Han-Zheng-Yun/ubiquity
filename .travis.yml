language: php

php:
  - 7.0
  - 7.1
  - 7.2
  - 7.3
services:
  - mysql

branches:
  only:
    - master
before_install:
  - sudo apt-get update
  - sudo apt-get install -y zip
  - travis_retry composer selfupdate

  - phantomjs --version
  - export PATH=$HOME/travis_phantomjs/phantomjs-2.1.1-linux-x86_64/bin:$PATH
  - phantomjs --version
  - if [ $(phantomjs --version) != '2.1.1' ]; then rm -rf $HOME/travis_phantomjs; mkdir -p $HOME/travis_phantomjs; fi
  - if [ $(phantomjs --version) != '2.1.1' ]; then travis_retry wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2 -O $HOME/travis_phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2; fi
  - if [ $(phantomjs --version) != '2.1.1' ]; then tar -xvf $HOME/travis_phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2 -C $HOME/travis_phantomjs; fi
  - phantomjs --version

install:
  - cp composer-tests.json composer.json
  - travis_retry composer install --no-interaction

  - mysql -u root mysql < tests/unit/db/messagerie.sql
  - (cd tests/fw && yes | ./../../vendor/bin/Ubiquity new prj-test-admin -b=messagerie -q=semantic -m -a)
  - cp tests/fw/_index.php tests/fw/prj-test-admin/index.php && cp tests/fw/.htrouter.php tests/fw/prj-test-admin/
  - cp -R Ubiquity tests/fw/prj-test-admin/Ubiquity/
  - cp codeception.yml tests/fw/prj-test-admin/codeception.yml
  - unzip tests/fw/tests.zip -d tests/fw/prj-test-admin/tests/
  - cp tests/fw/c3.php tests/fw/prj-test-admin/c3.php
  - cp tests/fw/composer.json tests/fw/prj-test-admin/
  - composer --working-dir=$(pwd)/tests/fw/prj-test-admin update

before_script:
  - mkdir -p build/logs
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - "nohup java -jar vendor/se/selenium-server-standalone/composer/bin/selenium-server-standalone.jar > /dev/null 2> /dev/null &"
  - sleep 3
  - (cd tests/fw/prj-test-admin/ && php -S 127.0.0.1:8090 .htrouter.php)
  - sleep 3

script:
  - ./vendor/bin/codecept build && ./vendor/bin/codecept run --steps --coverage-xml

after_script:
  - travis_retry wget https://scrutinizer-ci.com/ocular.phar
  - travis_retry php ocular.phar code-coverage:upload --format=php-clover tests/_output/coverage.xml